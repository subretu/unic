name: license_check

on:
  push:

jobs:
  license-check:
    name: License Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: 3.9
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Install dependencies
        run: poetry install --no-interaction --only main,workflow
      - name: Run Licenses List
        run: >
          poetry run pip-licenses
          --order=license
          --format=markdown
      - name: Run Licenses Check
        run: >
          poetry run pip-licenses --format=json --from=mixed --allow-only="" > licenses.json

      - name: Check Allow Licenses
        id: parse-licenses1
        run: |
          output=$(cat licenses.json)
          keys=$(echo "$output" | jq -r 'keys[]')
          allow_licenses=$(cat allow_licenses.txt)

          declare -A ng_licenses

          length=$(echo "$output" | jq 'length')

          for (( i = 0; i < length; i++ )); do
            license=$(echo "$output" | jq -r ".[$i].License")
            name=$(echo "$output" | jq -r ".[$i].Name")
            if [[ "$allow_licenses" != *"$license"* ]]; then
              ng_licenses["$name"]=$license
            fi
          done

          {
            for key in "${!ng_licenses[@]}"; do
              license=${ng_licenses[$key]}
              echo "\"$key\": \"$license\","
            done
          } | sed '$ s/,$//' | sed '1i{' | sed '$a}' > ng-licenses1.json

          cat ng-licenses1.json
